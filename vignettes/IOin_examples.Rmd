---
title: "IOin_examples"
author: "Will Burke"
date: "9/7/2020"
output: html_document
---

## RHESSysIOinR Input Functions

This vignette shows example uses of the IOin\_X functions, which together construct input data objects used to run one or many RHESSys simulations.

#### New/renamed input functions:

-   IOin\_rhessys\_input
-   IOin\_tec\_std
-   IOin\_cmd\_pars
-   IOin\_hdr
-   IOin\_clim
-   IOin\_def\_pars\_simple

### Setup

Using rhessys/Testing as example input data. If you don't already have develop branch of RHESsys cloned, get that now too.

```{r, setup, include=FALSE}
# to clone and checkout develop branch, a bit slow for some reason
# gert::git_clone(url = "https://github.com/RHESSys/RHESSys",
#                 path = "~/Repos/rhessys-devtest",
#                 branch = "develop")

knitr::opts_knit$set(root.dir = "~/Repos/rhessys-devtest/Testing/")
knitr::opts_chunk$set(echo = TRUE)
```

### Compile RHESSys

If needed

```{r, echo=FALSE, results='hide'}
library(RHESSysIOinR)
# Should work for both Mac and WSL (Windows)
#compile_rhessys(location = "../")
```

### IOin\_rhessys\_input

This is the basic RHESSys information needed to run RHESSys from the command line.

```{r }
input_rhessys = IOin_rhessys_input(
  version = "../rhessys/rhessys7.3",
  tec_file = "tecfiles/w8TC.tec",
  world_file = "worldfiles/w8TC.world",
  world_hdr_prefix = "w8TC",
  flowtable = "flowtables/w8TC.flow",
  start = "1988 10 1 1",
  end = "2000 10 1 1",
  output_folder = "out/",
  output_prefix = "w8TC",
  commandline_options = c("-g -b")
)
```

### IOin\_tec\_std

This creates a tec file, automatically adding entries for print\_daily\_on and print\_daily\_growth\_on based on the start date, and adding output\_current\_state at the end date. output\_current\_state can be toggled off by setting output\_state=FALSE.

```{r}
input_tec_data = IOin_tec_std(start = "1988 10 1 1",
                              end = "2000 10 1 1",
                              output_state = TRUE)
```

### IOin\_hdr

This creates a header file in a folder using the world\_hdr\_prefix from IOin\_rhessys\_input and using the def files specified in the function below.

```{r}
input_hdr = IOin_hdr(
  basin = "defs/basin.def",
  hillslope = "defs/hill.def",
  zone = "defs/zone.def",
  soil = "defs/soil_sandyloam.def",
  landuse = "defs/lu_undev.def",
  stratum = "defs/veg_douglasfir.def",
  basestations = "clim/w8_base"
)
```

### Run RHESSys

Together, these inputs (IOin\_X) can be used to run RHESSys for a single simulation with very simple options. Future additions will allow for pointing to already generated header and tec files.

```{r, echo=FALSE, results='hide'}
run_rhessys_single(
  input_rhessys = input_rhessys,
  hdr_files = input_hdr,
  tec_data = input_tec_data
)
```

### IOin\_std\_pars

Command line parameteres (standard paramters) are multipliers on some commonly varied exisitng paramter values (found in def files). Because it has become easier to modify the def file values directly, we are encoureging users to move away from this method of parameter variation, but this function is nonetheless how you would input/modify command line parameters.

```{r, echo=FALSE, results='hide'}
input_std_pars = IOin_std_pars(
  m = 0.355794,
  k = 651.390265,
  m_v = 0.355794,
  k_v = 651.390265,
  pa = 1.083102,
  po = 1.193924,
  gw1 = 0.116316,
  gw2 = 0.916922
)

run_rhessys_single(
  input_rhessys = input_rhessys,
  hdr_files = input_hdr,
  tec_data = input_tec_data,
  std_pars = input_std_pars
)
```

### IOin\_def\_pars

This function modifies def file parameters. This is done by creating modifed def files with the altered paramters, and pointing to that new def file in the header file. This allows for many parameter sets to be generated through many def files and associated header files.

```{r, echo=FALSE, results='hide'}
input_def_pars = IOin_def_pars_simple(
  list("defs/soil_sandyloam.def", "m", (0.12 * 0.355794)),
  list("defs/soil_sandyloam.def", "Ksat_0", (3 * 651.390265)),
  list("defs/soil_sandyloam.def", "m_z", (0.4 * 0.355794)),
  list("defs/soil_sandyloam.def", "pore_size_index", (0.195750 * 1.193924)),
  list("defs/soil_sandyloam.def", "psi_air_entry", (0.798750 * 1.083102)),
  list("defs/soil_sandyloam.def", "sat_to_gw_coeff",(0 * 0.116316)),
  list("defs/hill.def", "gw_loss_coeff", (0 *  0.916922))
)

run_rhessys_single(
  input_rhessys = input_rhessys,
  hdr_files = input_hdr,
  tec_data = input_tec_data,
  def_pars = input_def_pars
)
```

### IOin\_clim

This is just to generate a basestation on the fly, but can be useful when running across multiple climate series, and to ensure the paths in the base station file are correct.

```{r eval=FALSE}
input_clim = IOin_clim(
  base_station_id = 101,
  x_coordinate = 100.0,
  y_coordinate = 100.0,
  z_coordinate = 975,
  effective_lai = 3.5,
  screen_height = 160,
  daily_prefix = "clim/w8_daily"
)
```

### Output Variables

This will be supplanted by the new output filters method.

```{r eval=FALSE}
  # to use native R-based subsetting
  output_method = "r"
  my_vars = data.frame(c("pd", "Qout"),
                       c("pd", "psn"),
                       c("pdg", "lai"),
                       c("pdg", "plantc"),
                       c("cd", "height"))
  output_vars = IOin_output_vars(my_vars)
```

## Running Multiple Scenarios

The above input functions all generate RHESSys inputs for a single RHESSys run. With additional options, or different IOin\_X functions, multiple RHESSys scenarios can be generated, and run via `run_rhessys_multi()`.

The method for generating those multiple scenarios is flexible,, as long as the output data format adheres to what is expected input for `run_rhessys_multi()`. See the code/documentation/comments on `IOin_def_pars_simple()` for more info on the data format.

### IOin\_def\_pars\_sobol

This is still work in progress, but shows how sobol paramter sampling can be used to generate RHESSys inputs.

```{r, echo=FALSE, results='hide'}

# this gives the most flexibility to how users want to generate a distribution
n = 10
pars = list(
  list("defs/veg_douglasfir.def", "epc.waring_pa", runif(n, 0.1, 0.4)),
  list("defs/veg_douglasfir.def", "epc.proj_sla", runif(n, 2, 6)),
  list("defs/soil_sandyloam.def", "pore_size_index", runif(n, 0.2, 0.5)),
  list("defs/soil_sandyloam.def", "psi_air_entry", runif(n, 0.5, 8))
)

input_def_pars_sobol = IOin_def_pars_sobol(pars, nboot = 100)

run_rhessys_multi(
  input_rhessys = input_rhessys,
  hdr_files = input_hdr,
  tec_data = input_tec_data,
  def_pars = input_def_pars_sobol
)

```
